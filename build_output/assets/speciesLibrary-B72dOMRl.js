import{a as n,d as l,b as d,g as y,c as h,s as f,e as u}from"./index-CH3xiZGa.js";const x=2160*60*60*1e3;class b{constructor(){this.cache=new Map}async get(t,r){var e,s;const i=this.getKey(t,r);if(this.cache.has(i)){const a=this.cache.get(i);if(this.isExpired(a))n("debug","Species library cache entry expired",{key:i}),this.cache.delete(i);else return n("debug","Species library cache hit",{key:i,hit:!0}),a}try{const a=l(d,"species_library",i),p=await y(a);if(p.exists()){const c=p.data(),m=((e=c.enrichedAt)==null?void 0:e.toDate())||new Date,o={id:c.id,commonName:c.commonName,scientificName:c.scientificName,morphVariant:c.morphVariant,enrichmentData:c.enrichmentData,enrichedAt:m,expiresAt:((s=c.expiresAt)==null?void 0:s.toDate())||this.calculateExpiration(m)};return this.isExpired(o)?(n("info","Species library Firestore entry expired",{key:i}),null):(this.cache.set(i,o),n("info","Species library Firestore hit",{key:i,hit:!0}),o)}}catch(a){h("error","Species library Firestore load error",{error:a,key:i})}return null}isExpired(t){return t.expiresAt?new Date>t.expiresAt:!1}calculateExpiration(t){return new Date(t.getTime()+x)}async save(t){const r=this.getKey(t.commonName,t.morphVariant),i=t.enrichedAt||new Date,e={...t,enrichedAt:i,expiresAt:t.expiresAt||this.calculateExpiration(i)};this.cache.set(r,e),n("info","Species library cached",{key:r,expiresAt:e.expiresAt});try{const s=l(d,"species_library",r),a={id:e.id,commonName:e.commonName,enrichmentData:e.enrichmentData,enrichedAt:f(),expiresAt:e.expiresAt};e.scientificName!==void 0&&(a.scientificName=e.scientificName),e.morphVariant!==void 0&&e.morphVariant!==null&&(a.morphVariant=e.morphVariant),await u(s,a,{merge:!0}),h("info","Species library saved to Firestore",{key:r})}catch(s){h("error","Species library Firestore save failed",{error:s,key:r})}}getKey(t,r){const i=t.toLowerCase().trim(),e=(r==null?void 0:r.toLowerCase().trim())||"";return e?`${i}:${e}`:i}clearCache(){this.cache.clear(),n("info","Species library cache cleared")}}const g=new b;export{g as speciesLibrary};
